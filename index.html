<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lycapei accounting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* æŸ”å’Œæ°´å½©è‰²èª¿å®šç¾© */
        :root {
            /* Input Page ä¸»é¡Œè‰² (Pink) */
            --color-input-active: #EC4899; /* Pink */
            /* Summary Page ä¸»é¡Œè‰² (Blue) */
            --color-summary-active: #3B82F6; /* Blue */
            
            /* èƒŒæ™¯ */
            --bg-body: #F0F8FF; /* Very light, soft blue */
            
            /* Tab é¡è‰²ï¼šç²‰è‰²ç³»æ°´å½© (Input) */
            --bg-input-gradient: linear-gradient(135deg, #FFFAFD, #FFEAEF); 
            /* Tab é¡è‰²ï¼šè—è‰²ç³»æ°´å½© (Summary) */
            --bg-summary-gradient: linear-gradient(135deg, #F9FFFF, #EEF7FF); 
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
        }
        .app-card {
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.08);
            transition: background-image 0.5s ease;
        }
        .input-field {
            /* çµ±ä¸€è¨­å®šç™½åº•ã€é‚Šæ¡†èˆ‡åœ“è§’ */
            background-color: #FFFFFF; 
            border: 1px solid #E5E7EB;
            border-radius: 0.75rem;
            padding: 0.75rem;
            width: 100%; /* ç¢ºä¿å¯¬åº¦ä¸€è‡´ */
            transition: all 0.2s ease;
            height: 3rem; 
            box-sizing: border-box; /* ç¢ºä¿ padding/border ä¸å¢åŠ ç¸½é«˜åº¦ */
            /* ç¢ºä¿ type=date/time/datetime-local ä¸æœƒè¢«ç€è¦½å™¨æ·»åŠ é¡å¤–çš„å³é‚Šè· */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .input-field:focus {
            border-color: var(--color-input-active);
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }
        /* èª¿æ•´è¼¸å…¥æ¡†çš„å…§è·ï¼Œç¢ºä¿å®ƒå€‘çš„é«˜åº¦èˆ‡ select å°é½Š */
        #amount, #currencyInput, #timestamp {
             padding-top: 0.75rem; 
             padding-bottom: 0.75rem;
        }
    </style>
    <script>
        // è¨­å®š Tailwind CSS é…ç½®
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'soft-pink': '#FFECF8',
                        'soft-blue': '#E0F2FE',
                        // æ–°å¢ç”¨æ–¼è¨Šæ¯çš„é¡è‰²
                        'soft-green': '#D1FAE5',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <div id="app" class="w-full max-w-md app-card p-6 pt-0 flex flex-col min-h-[90vh]" style="background-image: var(--bg-input-gradient);">
        
        <header class="py-4 sticky top-0 bg-transparent backdrop-blur-sm z-10 mb-4 rounded-b-xl">
            <h1 class="text-3xl font-bold text-gray-800 text-center">lycapei accounting</h1>
        </header>

        <nav class="flex mb-6 p-1 bg-gray-100 rounded-full shadow-inner">
            <button type="button" id="inputTabBtn" onclick="switchTab('input')" 
                    class="flex-1 py-2 flex items-center justify-center space-x-2 text-sm font-semibold rounded-full transition-all duration-300">
                <i data-lucide="pencil-line" class="w-4 h-4"></i>
                <span>è³‡æ–™è¼¸å…¥</span>
            </button>
            <button type="button" id="summaryTabBtn" onclick="switchTab('summary')" 
                    class="flex-1 py-2 flex items-center justify-center space-x-2 text-sm font-semibold rounded-full transition-all duration-300">
                <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                <span>æ‘˜è¦</span>
            </button>
        </nav>

        <div id="inputView" class="tab-content flex-grow">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">æ–°å¢äº¤æ˜“ç´€éŒ„</h2>
            
            <div id="transactionTypeSwitch" class="flex mb-6 p-1 bg-gray-100 rounded-full shadow-inner">
                <button type="button" data-type="expense" onclick="setTransactionType('expense')" 
                        class="flex-1 py-2 text-xs font-semibold rounded-full transition-all duration-300 text-gray-600">
                    <i data-lucide="minus-circle" class="w-4 h-4 inline mr-1"></i> æ”¯å‡º
                </button>
                <button type="button" data-type="income" onclick="setTransactionType('income')" 
                        class="flex-1 py-2 text-xs font-semibold rounded-full transition-all duration-300 text-gray-600">
                    <i data-lucide="plus-circle" class="w-4 h-4 inline mr-1"></i> æ”¶å…¥
                </button>
                <button type="button" data-type="transfer" onclick="setTransactionType('transfer')" 
                        class="flex-1 py-2 text-xs font-semibold rounded-full transition-all duration-300 text-gray-600">
                    <i data-lucide="arrow-right-left" class="w-4 h-4 inline mr-1"></i> è½‰å¸³
                </button>
            </div>
            
            <form id="transactionForm" class="space-y-4">
                
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-1 flex items-center space-x-2">
                        <i data-lucide="dollar-sign" class="w-4 h-4 text-gray-700"></i>
                        <span>é‡‘é¡èˆ‡è²¨å¹£</span>
                    </label>
                    <div class="flex space-x-3">
                        <div id="currencyInputContainer" class="w-1/3 relative">
                            <select id="currencySelect" name="currencySelect" onchange="handleCurrencyChange(this.value)" 
                                class="input-field appearance-none px-2 text-center text-sm font-semibold text-pink-700">
                                <option value="TWD" selected>TWD</option>
                                <option value="USD">USD</option>
                                <option value="JPY">JPY</option>
                                <option value="Other">å…¶ä»–</option>
                            </select>
                            
                            <div id="manualCurrencyContainer" class="absolute inset-0 hidden">
                                <input type="text" id="currencyInput" name="currencyInput" 
                                    class="input-field appearance-none px-2 text-center text-sm font-semibold text-pink-700 pr-8" 
                                    placeholder="ä»£ç¢¼ (EUR)" maxlength="5">
                                <button type="button" onclick="resetCurrencySelect()" 
                                        class="absolute right-0 top-1/2 transform -translate-y-1/2 mr-1 h-8 w-8 flex items-center justify-center text-gray-400 hover:text-pink-600 transition-colors focus:outline-none">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="w-2/3">
                            <input type="number" id="amount" name="amount" required class="input-field text-lg font-bold text-pink-700" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div id="singleAccountContainer">
                    <label for="account" id="singleAccountLabel" class="block text-sm font-medium text-gray-700 mb-1 flex items-center space-x-2">
                        <i data-lucide="wallet" class="w-4 h-4 text-gray-700"></i>
                        <span>æ”¯ä»˜å¸³æˆ¶/é¡å‹</span>
                    </label>
                    <select id="account" name="account" class="input-field appearance-none">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="ç¾é‡‘-å°å¹£">ç¾é‡‘ - å°å¹£</option>
                        <option value="ç¾é‡‘-å¤–å¹£ USD">ç¾é‡‘ - å¤–å¹£ USD</option>
                        <option value="æ´»å­˜-ä¸­ä¿¡å°å¹£">æ´»å­˜ - ä¸­ä¿¡å°å¹£</option>
                        <option value="æ´»å­˜-ç‰å±±å°å¹£">æ´»å­˜ - ç‰å±±å°å¹£</option>
                        <option value="ä¿¡ç”¨å¡-Richart">ä¿¡ç”¨å¡ - Richart</option>
                        <option value="ä¿¡ç”¨å¡-ç‰å±±">ä¿¡ç”¨å¡ - ç‰å±±</option>
                    </select>
                </div>
                
                <div id="transferAccountContainer" class="hidden space-y-4">
                    <div>
                        <label for="sourceAccount" class="block text-sm font-medium text-gray-700 mb-1 flex items-center space-x-2">
                            <i data-lucide="arrow-up-right-from-circle" class="w-4 h-4 text-gray-700"></i>
                            <span>è½‰å‡ºå¸³æˆ¶ (Source)</span>
                        </label>
                        <select id="sourceAccount" name="sourceAccount" class="input-field appearance-none">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="ç¾é‡‘-å°å¹£">ç¾é‡‘ - å°å¹£</option>
                            <option value="ç¾é‡‘-å¤–å¹£ USD">ç¾é‡‘ - å¤–å¹£ USD</option>
                            <option value="æ´»å­˜-ä¸­ä¿¡å°å¹£">æ´»å­˜ - ä¸­ä¿¡å°å¹£</option>
                            <option value="æ´»å­˜-ç‰å±±å°å¹£">æ´»å­˜ - ç‰å±±å°å¹£</option>
                            <option value="ä¿¡ç”¨å¡-Richart">ä¿¡ç”¨å¡ - Richart</option>
                            <option value="ä¿¡ç”¨å¡-ç‰å±±">ä¿¡ç”¨å¡ - ç‰å±±</option>
                        </select>
                    </div>
                    <div>
                        <label for="destinationAccount" class="block text-sm font-medium text-gray-700 mb-1 flex items-center space-x-2">
                            <i data-lucide="arrow-down-left-from-circle" class="w-4 h-4 text-gray-700"></i>
                            <span>è½‰å…¥å¸³æˆ¶ (Destination)</span>
                        </label>
                        <select id="destinationAccount" name="destinationAccount" class="input-field appearance-none">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="ç¾é‡‘-å°å¹£">ç¾é‡‘ - å°å¹£</option>
                            <option value="ç¾é‡‘-å¤–å¹£ USD">ç¾é‡‘ - å¤–å¹£ USD</option>
                            <option value="æ´»å­˜-ä¸­ä¿¡å°å¹£">æ´»å­˜ - ä¸­ä¿¡å°å¹£</option>
                            <option value="æ´»å­˜-ç‰å±±å°å¹£">æ´»å­˜ - ç‰å±±å°å¹£</option>
                            <option value="ä¿¡ç”¨å¡-Richart">ä¿¡ç”¨å¡ - Richart</option>
                            <option value="ä¿¡ç”¨å¡-ç‰å±±">ä¿¡ç”¨å¡ - ç‰å±±</option>
                        </select>
                    </div>
                </div>

                <div id="categoryContainer">
                    <label for="category" id="categoryLabel" class="block text-sm font-medium text-gray-700 mb-1 flex items-center space-x-2">
                        <i data-lucide="tag" class="w-4 h-4 text-gray-700"></i>
                        <span>é¡åˆ¥ (é£Ÿè¡£ä½è¡Œè‚²æ¨‚)</span>
                    </label>
                    <select id="category" name="category" class="input-field appearance-none">
                        </select>
                </div>

                <div>
                    <label for="timestamp" class="block text-sm font-medium text-gray-700 mb-1 flex items-center space-x-2">
                        <i data-lucide="calendar" class="w-4 h-4 text-gray-700"></i>
                        <span>æ—¥æœŸèˆ‡æ™‚é–“</span>
                    </label>
                    <input type="datetime-local" id="timestamp" name="timestamp" required class="input-field appearance-none">
                </div>
                
                <div id="pendingStatusContainer" class="pt-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center space-x-2">
                        <i data-lucide="check-square" class="w-4 h-4 text-gray-700"></i>
                        <span>æ”¯ä»˜ç‹€æ…‹ (åƒ…é™æ”¯å‡º)</span>
                    </label>
                    <div class="flex p-1 bg-gray-100 rounded-full shadow-inner">
                        <button type="button" id="paidBtn" onclick="setPendingStatus(false)" 
                                class="flex-1 py-2 flex items-center justify-center space-x-2 text-sm font-semibold rounded-full transition-all duration-300">
                            <i data-lucide="check-circle" class="w-4 h-4"></i>
                            <span>å¯¦ä»˜/å·²æ‰£æ¬¾</span>
                        </button>
                        <button type="button" id="pendingBtn" onclick="setPendingStatus(true)" 
                                class="flex-1 py-2 flex items-center justify-center space-x-2 text-sm font-semibold rounded-full transition-all duration-300">
                            <i data-lucide="clock" class="w-4 h-4"></i>
                            <span>é æˆæ¬Š (éå¯¦æ‰£)</span>
                        </button>
                    </div>
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1 flex items-center space-x-2">
                        <i data-lucide="message-square" class="w-4 h-4 text-gray-700"></i>
                        <span>å‚™è¨»/èªªæ˜</span>
                    </label>
                    <input type="text" id="description" name="description" class="input-field">
                </div>


                <button type="submit" id="submitBtn" class="w-full py-3 mt-6 flex items-center justify-center space-x-2 text-lg font-bold text-white bg-pink-600 hover:bg-pink-700 rounded-xl transition-transform transform hover:scale-[1.01] shadow-lg shadow-pink-300">
                    <i data-lucide="save" class="w-5 h-5"></i>
                    <span id="submitButtonText">å„²å­˜æ”¯å‡ºç´€éŒ„</span>
                </button>
            </form>

            <div id="messageBox" class="mt-4 p-3 hidden rounded-xl text-center font-medium"></div>
        </div>

        <div id="summaryView" class="tab-content hidden flex-grow">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">æ”¯å‡ºæ‘˜è¦åˆ†æ</h2>
            
            <div class="flex mb-4 p-1 bg-gray-100 rounded-full shadow-inner">
                <button type="button" id="viewToggleMonth" onclick="setSummaryView('month')" class="flex-1 py-2 text-xs font-semibold rounded-full transition-all duration-300">
                    <i data-lucide="calendar-check" class="w-4 h-4 inline mr-1"></i> æœˆåº¦æ‘˜è¦
                </button>
                <button type="button" id="viewToggleYear" onclick="setSummaryView('year')" class="flex-1 py-2 text-xs font-semibold rounded-full transition-all duration-300 text-gray-600">
                    <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i> å¹´åº¦æ‘˜è¦
                </button>
            </div>

            <div class="space-y-4">
                
                <div class="app-card p-4 bg-soft-blue/50 text-center">
                    <p class="text-sm font-medium text-gray-700" id="summaryPeriodText">2025å¹´12æœˆ ç¸½çµ (åŒ…å«æ”¶å…¥)</p>
                    <div class="flex justify-around items-center mt-2">
                        <div>
                             <p class="text-xs text-gray-500">ç¸½æ”¶å…¥ (TWD)</p>
                             <p class="text-2xl font-bold text-green-600" id="totalIncomeTWD">0</p>
                        </div>
                        <div>
                             <p class="text-xs text-gray-500">ç¸½æ”¯å‡º (TWD)</p>
                             <p class="text-2xl font-bold text-red-600" id="totalExpenseTWD">0</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-blue-200">
                        <p class="text-sm font-medium text-gray-700">æ·¨é¡ (TWD)</p>
                        <p class="text-3xl font-extrabold" id="netFlowTWD">TWD 0</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">æ³¨æ„ï¼šå¤šå¹£åˆ¥é‡‘é¡æœªæ›ç®—åˆè¨ˆ</p>
                </div>


                <div class="app-card p-4 bg-white">
                    <h3 class="text-lg font-semibold border-b pb-2 mb-3 text-gray-700 flex items-center space-x-2">
                        <i data-lucide="tag" class="w-5 h-5 text-blue-500"></i>
                        <span>æŒ‰é¡åˆ¥ç¸½èŠ±è²» (TWD)</span>
                    </h3>
                    <ul id="categorySummaryList" class="space-y-3">
                        <li class="flex justify-between items-center text-gray-500">
                            <span>è«‹å…ˆè¼¸å…¥äº¤æ˜“è³‡æ–™</span>
                        </li>
                    </ul>
                </div>

                <div class="app-card p-4 bg-white">
                    <h3 class="text-lg font-semibold border-b pb-2 mb-3 text-gray-700 flex items-center space-x-2">
                        <i data-lucide="wallet" class="w-5 h-5 text-blue-500"></i>
                        <span>æŒ‰æ”¯ä»˜å¸³æˆ¶ç¸½æ·¨é¡</span>
                    </h3>
                    <ul id="accountSummaryList" class="space-y-3">
                        </ul>
                </div>

                <div class="app-card p-4 bg-white">
                    <h3 class="text-lg font-semibold border-b pb-2 mb-3 text-gray-700 flex items-center space-x-2">
                        <i data-lucide="list-checks" class="w-5 h-5 text-blue-500"></i>
                        <span>å€é–“äº¤æ˜“æ˜ç´°</span>
                    </h3>
                    <ul id="transactionDetailList" class="space-y-2">
                        </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ğŸš¨ å¿…å¡«ï¼šæ‚¨çš„ Google Apps Script Web App éƒ¨ç½² URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzUmKHMMQ_22rg-rk8i0vJnMjR5L9gpppvx0jI9yG6PVffZjJ84HmPOt_O_5uN8tRWA/exec'; 
        
        // ============== å…¨å±€ç‹€æ…‹èˆ‡é…ç½® ==============
        let currentTab = 'input';
        let summaryViewType = 'month'; // 'month' or 'year'
        let isPendingStatus = false; // é è¨­ç‚º å¯¦ä»˜/å·²æ‰£æ¬¾ (false)
        let currentTransactionType = 'expense'; // äº¤æ˜“é¡å‹ç‹€æ…‹
        let allTransactionsData = []; // ğŸ“¢ æ–°å¢ï¼šå„²å­˜å¾ Apps Script è®€å–çš„æ‰€æœ‰äº¤æ˜“è³‡æ–™

        // äº¤æ˜“é¡åˆ¥é¸é …
        const categoryOptions = {
            expense: [
                { value: 'é£Ÿ', label: 'é£Ÿ (é£²é£Ÿ)' },
                { value: 'è¡£', label: 'è¡£ (æœé£¾)' },
                { value: 'ä½', label: 'ä½ (å±…å®¶)' },
                { value: 'è¡Œ', label: 'è¡Œ (äº¤é€š)' },
                { value: 'è‚²', label: 'è‚² (å­¸ç¿’)' },
                { value: 'æ¨‚', label: 'æ¨‚ (å¨›æ¨‚)' },
                { value: 'å›ºå®šæ”¯å‡º', label: 'å›ºå®šæ”¯å‡º' },
                { value: 'æŠ•è³‡', label: 'æŠ•è³‡/è³‡ç”¢è½‰ç§»' },
                { value: 'å…¶ä»–', label: 'å…¶ä»–æ”¯å‡º' },
            ],
            income: [
                { value: 'è–ªè³‡', label: 'è–ªè³‡' },
                { value: 'åˆ©æ¯/è‚¡åˆ©', label: 'åˆ©æ¯/è‚¡åˆ©æ”¶å…¥' },
                { value: 'çé‡‘', label: 'çé‡‘/è£œåŠ©' },
                { value: 'ä»–äººè½‰å¸³', label: 'ä»–äººè½‰å¸³/ç¦®ç‰©' },
                { value: 'å…¶ä»–', label: 'å…¶ä»–æ”¶å…¥' },
            ]
        };

        // ============== è¼”åŠ©å‡½å¼ ==============
        
        /**
         * åˆ‡æ›ä¸»ä»‹é¢è¦–åœ– (è¼¸å…¥/æ‘˜è¦)
         * @param {string} tabName - 'input' or 'summary'
         */
        function switchTab(tabName) {
            currentTab = tabName;
            const app = document.getElementById('app');
            const inputView = document.getElementById('inputView');
            const summaryView = document.getElementById('summaryView');
            const inputTabBtn = document.getElementById('inputTabBtn');
            const summaryTabBtn = document.getElementById('summaryTabBtn');
            
            // æ¨£å¼é…ç½®
            const inputActiveClasses = 'bg-pink-500 text-white shadow-lg';
            const summaryActiveClasses = 'bg-blue-500 text-white shadow-lg';
            const inactiveClasses = 'text-gray-600 bg-gray-50'; 

            // 1. ä»‹é¢å…§å®¹åˆ‡æ›
            inputView.classList.toggle('hidden', tabName !== 'input');
            summaryView.classList.toggle('hidden', tabName !== 'summary');
            
            // 2. ä¸»å¡ç‰‡èƒŒæ™¯åˆ‡æ›
            app.style.backgroundImage = tabName === 'input' ? 'var(--bg-input-gradient)' : 'var(--bg-summary-gradient)';

            // 3. å°èˆªæŒ‰éˆ•æ¨£å¼åˆ‡æ›
            [inputTabBtn, summaryTabBtn].forEach(btn => {
                btn.classList.remove(...inputActiveClasses.split(' '), ...summaryActiveClasses.split(' '), ...inactiveClasses.split(' '));
            });

            if (tabName === 'input') {
                inputTabBtn.classList.add(...inputActiveClasses.split(' '));
                summaryTabBtn.classList.add(...inactiveClasses.split(' '));
            } else {
                summaryTabBtn.classList.add(...summaryActiveClasses.split(' '));
                inputTabBtn.classList.add(...inactiveClasses.split(' '));
                // æ ¸å¿ƒä¿®æ­£ï¼šé€²å…¥æ‘˜è¦é é¢æ™‚ï¼Œè¼‰å…¥ä¸¦æ¸²æŸ“
                loadAndRenderSummary(); 
            }
            // æ¯æ¬¡åˆ‡æ›æ™‚é‡æ–°æ¸²æŸ“åœ–æ¨™
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        /**
         * æ ¼å¼åŒ–é‡‘é¡ï¼Œå‰é¢å¸¶ä¸Šè²¨å¹£ä»£ç¢¼
         * @param {number} amount 
         * @param {string} currency 
         * @returns {string}
         */
        function formatCurrencyDisplay(amount, currency, isNegative = false) {
            const displayAmount = Math.round(Math.abs(amount)).toLocaleString('zh-TW');
            const sign = isNegative ? '-' : '';
            return `${sign}${currency} ${displayAmount}`;
        }

        /**
         * é¡¯ç¤º/éš±è—è¨Šæ¯æ–¹å¡Š
         * @param {string} message 
         * @param {string} type 'success' or 'error'
         */
        function showMessage(message, type) {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.classList.remove('hidden', 'bg-soft-pink/80', 'text-red-700', 'bg-soft-green/80', 'text-green-700');
            box.classList.add(type === 'success' ? 'bg-soft-green/80' : 'bg-soft-pink/80', type === 'success' ? 'text-green-700' : 'text-red-700');
            
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        /**
         * è™•ç†è²¨å¹£é¸æ“‡è®ŠåŒ–ï¼Œåˆ‡æ› Select å’Œ Manual Input Container
         * @param {string} value 
         */
        function handleCurrencyChange(value) {
            const select = document.getElementById('currencySelect');
            const manualContainer = document.getElementById('manualCurrencyContainer');
            
            if (value === 'Other') {
                select.classList.add('hidden');
                manualContainer.classList.remove('hidden');
                document.getElementById('currencyInput').focus();
            } else {
                select.classList.remove('hidden');
                manualContainer.classList.add('hidden');
            }
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        /**
         * å¾æ‰‹å‹•è¼¸å…¥åˆ‡æ›å›ä¸‹æ‹‰å¼é¸å–®
         */
        function resetCurrencySelect() {
            const select = document.getElementById('currencySelect');
            const manualContainer = document.getElementById('manualCurrencyContainer');
            
            manualContainer.classList.add('hidden');
            select.classList.remove('hidden');
            select.value = 'TWD';
            document.getElementById('currencyInput').value = ''; 
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }
        
        /**
         * è™•ç†æ”¯ä»˜ç‹€æ…‹åˆ‡æ› (å¯¦ä»˜/é æˆæ¬Š)
         * @param {boolean} isPending - true: é æˆæ¬Š, false: å¯¦ä»˜
         */
        function setPendingStatus(isPending) {
            isPendingStatus = isPending;
            const paidBtn = document.getElementById('paidBtn');
            const pendingBtn = document.getElementById('pendingBtn');

            const activeClass = 'bg-pink-500 text-white shadow-md'; 
            const inactiveClass = 'text-gray-600 bg-gray-50'; 

            paidBtn.classList.remove(...activeClass.split(' '), ...inactiveClass.split(' '));
            pendingBtn.classList.remove(...activeClass.split(' '), ...inactiveClass.split(' '));

            if (!isPending) {
                paidBtn.classList.add(...activeClass.split(' '));
                pendingBtn.classList.add(...inactiveClass.split(' '));
            } else {
                pendingBtn.classList.add(...activeClass.split(' '));
                paidBtn.classList.add(...inactiveClass.split(' '));
            }
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }
        
        /**
         * æ ¹æ“šé¸æ“‡çš„é¡å‹ï¼Œèª¿æ•´è¡¨å–® UI
         * @param {string} type - 'expense', 'income', 'transfer'
         */
        function setTransactionType(type) {
            currentTransactionType = type;
            const allBtns = document.querySelectorAll('#transactionTypeSwitch button');
            const activeClass = 'bg-pink-500 text-white shadow-md'; 
            const inactiveClass = 'text-gray-600 bg-gray-50'; // ç¢ºä¿ inactive ä¹Ÿæœ‰èƒŒæ™¯è‰²

            // 1. æŒ‰éˆ•æ¨£å¼
            allBtns.forEach(btn => {
                // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„æ¨£å¼ï¼Œç¢ºä¿åˆ‡æ›ä¹¾æ·¨
                btn.classList.remove(...activeClass.split(' '), ...inactiveClass.split(' ')); 
                if (btn.getAttribute('data-type') === type) {
                    btn.classList.add(...activeClass.split(' '));
                } else {
                    btn.classList.add(...inactiveClass.split(' ')); // ä½¿ç”¨ inactiveClass
                }
            });

            // 2. è¡¨å–®æ¬„ä½èª¿æ•´
            const singleAccountContainer = document.getElementById('singleAccountContainer');
            const transferAccountContainer = document.getElementById('transferAccountContainer');
            const categoryContainer = document.getElementById('categoryContainer');
            const singleAccountLabel = document.getElementById('singleAccountLabel');
            const categorySelect = document.getElementById('category');
            const categoryLabel = document.getElementById('categoryLabel').querySelector('span');
            const pendingStatusContainer = document.getElementById('pendingStatusContainer');
            const submitButtonText = document.getElementById('submitButtonText');
            
            // æ¸…ç©ºé¡åˆ¥é¸é …
            categorySelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>'; 
            
            // é‡è¨­å¿…å¡«å±¬æ€§
            document.getElementById('account').required = false;
            document.getElementById('sourceAccount').required = false;
            document.getElementById('destinationAccount').required = false;
            document.getElementById('category').required = false;

            switch (type) {
                case 'expense':
                    // é¡¯ç¤ºå–®ä¸€å¸³æˆ¶ (æ”¯ä»˜)ï¼Œé¡¯ç¤ºé¡åˆ¥ (æ”¯å‡º)ï¼Œé¡¯ç¤ºç‹€æ…‹
                    singleAccountContainer.classList.remove('hidden');
                    transferAccountContainer.classList.add('hidden');
                    categoryContainer.classList.remove('hidden');
                    pendingStatusContainer.classList.remove('hidden');

                    singleAccountLabel.querySelector('span').textContent = 'æ”¯ä»˜å¸³æˆ¶/é¡å‹';
                    categoryLabel.textContent = 'é¡åˆ¥ (é£Ÿè¡£ä½è¡Œè‚²æ¨‚)';
                    submitButtonText.textContent = 'å„²å­˜æ”¯å‡ºç´€éŒ„';
                    
                    // å¡«å……æ”¯å‡ºé¡åˆ¥é¸é …
                    categoryOptions.expense.forEach(opt => categorySelect.innerHTML += `<option value="${opt.value}">${opt.label}</option>`);
                    
                    document.getElementById('account').required = true;
                    document.getElementById('category').required = true;
                    break;

                case 'income':
                    // é¡¯ç¤ºå–®ä¸€å¸³æˆ¶ (å­˜å…¥)ï¼Œé¡¯ç¤ºé¡åˆ¥ (æ”¶å…¥)ï¼Œéš±è—ç‹€æ…‹
                    singleAccountContainer.classList.remove('hidden');
                    transferAccountContainer.classList.add('hidden');
                    categoryContainer.classList.remove('hidden');
                    pendingStatusContainer.classList.add('hidden');

                    singleAccountLabel.querySelector('span').textContent = 'å­˜å…¥å¸³æˆ¶/é¡å‹ (æ”¶å…¥)';
                    categoryLabel.textContent = 'æ”¶å…¥ä¾†æº/é¡åˆ¥';
                    submitButtonText.textContent = 'å„²å­˜æ”¶å…¥ç´€éŒ„';

                    // å¡«å……æ”¶å…¥é¡åˆ¥é¸é …
                    categoryOptions.income.forEach(opt => categorySelect.innerHTML += `<option value="${opt.value}">${opt.label}</option>`);
                    
                    document.getElementById('account').required = true;
                    document.getElementById('category').required = true;
                    break;

                case 'transfer':
                    // éš±è—å–®ä¸€å¸³æˆ¶ï¼Œé¡¯ç¤ºé›™å¸³æˆ¶ (è½‰å‡º/è½‰å…¥)ï¼Œéš±è—é¡åˆ¥ï¼Œéš±è—ç‹€æ…‹
                    singleAccountContainer.classList.add('hidden');
                    transferAccountContainer.classList.remove('hidden');
                    categoryContainer.classList.add('hidden');
                    pendingStatusContainer.classList.add('hidden');

                    submitButtonText.textContent = 'å„²å­˜è½‰å¸³ç´€éŒ„';
                    
                    document.getElementById('sourceAccount').required = true;
                    document.getElementById('destinationAccount').required = true;
                    break;
            }
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons(); // é‡æ–°æ¸²æŸ“åœ–æ¨™
            }
        }


        // ============== 1. è³‡æ–™è¼¸å…¥èˆ‡ API é‚è¼¯ (ä½¿ç”¨ Fetch API) ==============
        
        /**
         * è™•ç† Apps Script æˆåŠŸéŸ¿æ‡‰çš„å›èª¿å‡½å¼ (å¯«å…¥)
         * @param {Object} response - å¾ Apps Script çš„ doPost è¿”å›çš„ JSON ç‰©ä»¶ { status: 'success', message: ... }
         * @param {Function} resetForm - æ¸…ç©ºè¡¨å–®çš„å‡½å¼
         */
        function handleSuccess(response, resetForm) {
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.dataset.originalText;
            document.getElementById('submitButtonText').textContent = originalText;
            submitBtn.disabled = false;

            // æª¢æŸ¥å¾Œç«¯ Apps Script è¿”å›çš„ç‹€æ…‹
            if (response.status === 'success') {
                showMessage(`ğŸ‰ ${response.message}`, 'success');
                // å¯«å…¥æˆåŠŸå¾Œï¼Œæ¸…ç©ºè¡¨å–®
                resetForm();

                // ğŸ“¢ å¯«å…¥æˆåŠŸå¾Œï¼Œé‡æ–°è¼‰å…¥æ‘˜è¦æ•¸æ“šä»¥ç¢ºä¿æœ€æ–°
                if (currentTab === 'summary') {
                    loadAndRenderSummary();
                }

            } else if (response.status === 'error') {
                // Apps Script å…§éƒ¨é‚è¼¯éŒ¯èª¤ (ä¾‹å¦‚æ‰¾ä¸åˆ°å·¥ä½œè¡¨ç­‰)
                showMessage(`âŒ ä¼ºæœå™¨éŒ¯èª¤: ${response.message}`, 'error');
            } else {
                // æ„å¤–çš„éŸ¿æ‡‰æ ¼å¼
                showMessage('âš ï¸ Apps Script è¿”å›æœªçŸ¥æ ¼å¼çš„éŸ¿æ‡‰ã€‚', 'error');
            }
        }

        /**
         * è™•ç† Apps Script å¤±æ•—éŸ¿æ‡‰çš„å›èª¿å‡½å¼
         * @param {Error} error - Fetch æˆ– Apps Script åŸ·è¡Œç’°å¢ƒæ‹‹å‡ºçš„ç•°å¸¸
         */
        function handleError(error) {
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.dataset.originalText;
            document.getElementById('submitButtonText').textContent = originalText;
            submitBtn.disabled = false;

            showMessage(`âŒ é€£ç·šå¤±æ•—æˆ–éƒ¨ç½²éŒ¯èª¤: ${error.message}`, 'error');
        }


        /**
         * å°‡å–®ç­†äº¤æ˜“è³‡æ–™ç™¼é€åˆ° Apps Script é€²è¡Œå„²å­˜ (ä½¿ç”¨æ¨™æº– Fetch API)
         * @param {object|array} transaction äº¤æ˜“è³‡æ–™æˆ–äº¤æ˜“é™£åˆ—
         * @param {Function} resetForm æˆåŠŸå¾Œç”¨ä¾†é‡è¨­è¡¨å–®çš„å‡½å¼
         */
        async function saveTransactionToSheet(transaction, resetForm) {
            if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL_HERE') {
                handleError({ message: 'è«‹åœ¨ HTML ç¨‹å¼ç¢¼ä¸­è¨­ç½®æ­£ç¢ºçš„ APPS_SCRIPT_URL!' });
                return;
            }

            try {
                // é—œéµä¿®æ­£ï¼šContent-Type è¨­ç½®ç‚º text/plain ä»¥é¿å… CORS é æª¢
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', 
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8' 
                    },
                    // å°‡äº¤æ˜“ç‰©ä»¶åŒ…è£¹æˆ JSON å­—ä¸²ç™¼é€
                    body: JSON.stringify({ transaction: transaction }) 
                });

                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
                }
                
                const data = await response.json(); // è§£æ Apps Script è¿”å›çš„ JSON éŸ¿æ‡‰

                if (data.status === 'success') {
                    handleSuccess(data, resetForm);
                } else {
                    handleError({ message: data.message });
                }

            } catch (error) {
                // æ•ç²ç¶²è·¯éŒ¯èª¤æˆ– JSON è§£æéŒ¯èª¤
                handleError({ message: `é€£ç·šæˆ–è™•ç†å¤±æ•—: ${error.message}` });
            }
        }


        document.getElementById('transactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = this;
            const formData = new FormData(form);
            const currencySelectValue = document.getElementById('currencySelect').value;
            let currencyCode;
            
            // è²¨å¹£ä»£ç¢¼æª¢æŸ¥
            if (currencySelectValue === 'Other') {
                 currencyCode = document.getElementById('currencyInput').value.toUpperCase().trim();
                 if (!currencyCode) {
                     showMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„è²¨å¹£ä»£ç¢¼ï¼', 'error');
                     return;
                 }
            } else {
                currencyCode = currencySelectValue;
            }

            const baseAmount = parseFloat(formData.get('amount'));
            if (isNaN(baseAmount) || baseAmount <= 0) {
                showMessage('é‡‘é¡è¼¸å…¥ç„¡æ•ˆï¼', 'error');
                return;
            }
            
            const timestamp = new Date(formData.get('timestamp')).toISOString();
            const description = formData.get('description') || '';
            const pendingStatus = isPendingStatus;

            let transactionsToSave = [];
            let successMessage = '';
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.dataset.originalText = document.getElementById('submitButtonText').textContent; // å„²å­˜åŸå§‹æ–‡å­—
            
            document.getElementById('submitButtonText').textContent = 'å‚³è¼¸èˆ‡é©—è­‰ä¸­...';
            submitBtn.disabled = true;

            // æ ¹æ“šäº¤æ˜“é¡å‹è™•ç†
            if (currentTransactionType === 'expense' || currentTransactionType === 'income') {
                const type = currentTransactionType;
                const account = formData.get('account');
                const category = formData.get('category');

                if (!account || !category) {
                     showMessage('è«‹é¸æ“‡å¸³æˆ¶å’Œé¡åˆ¥ï¼', 'error');
                     submitBtn.disabled = false;
                     document.getElementById('submitButtonText').textContent = submitBtn.dataset.originalText;
                     return;
                }

                transactionsToSave.push({
                    type: type, 
                    amount: type === 'expense' ? -baseAmount : baseAmount, 
                    currency: currencyCode,
                    account: account,
                    timestamp: timestamp,
                    category: category,
                    description: description,
                    isPending: type === 'expense' ? pendingStatus : false, 
                });
                
                successMessage = `è³‡æ–™å‚³è¼¸ä¸­: ${type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'} ${formatCurrencyDisplay(baseAmount, currencyCode)}`;

            } else if (currentTransactionType === 'transfer') {
                const sourceAccount = formData.get('sourceAccount');
                const destinationAccount = formData.get('destinationAccount');

                if (!sourceAccount || !destinationAccount) {
                    showMessage('è«‹é¸æ“‡è½‰å‡ºå¸³æˆ¶å’Œè½‰å…¥å¸³æˆ¶ï¼', 'error');
                    submitBtn.disabled = false;
                    document.getElementById('submitButtonText').textContent = submitBtn.dataset.originalText;
                    return;
                }
                
                if (sourceAccount === destinationAccount) {
                    showMessage('è½‰å‡ºå¸³æˆ¶å’Œè½‰å…¥å¸³æˆ¶ä¸èƒ½ç›¸åŒï¼', 'error');
                    submitBtn.disabled = false;
                    document.getElementById('submitButtonText').textContent = submitBtn.dataset.originalText;
                    return;
                }

                // è½‰å‡º (è¨ˆç‚ºè² å€¼)
                transactionsToSave.push({
                    type: 'transfer_out', 
                    amount: -baseAmount, 
                    currency: currencyCode,
                    account: sourceAccount,
                    timestamp: timestamp,
                    category: 'è½‰å¸³', 
                    description: description,
                    isPending: false, 
                    relatedAccount: destinationAccount 
                });

                // è½‰å…¥ (è¨ˆç‚ºæ­£å€¼)
                transactionsToSave.push({
                    type: 'transfer_in', 
                    amount: baseAmount, 
                    currency: currencyCode,
                    account: destinationAccount,
                    timestamp: timestamp,
                    category: 'è½‰å¸³', 
                    description: description,
                    isPending: false, 
                    relatedAccount: sourceAccount 
                });
                
                successMessage = `è³‡æ–™å‚³è¼¸ä¸­: è½‰å¸³ ${formatCurrencyDisplay(baseAmount, currencyCode)}`;
            }

            // é¡¯ç¤ºç¶œåˆè¨Šæ¯ (è³‡æ–™å‚³è¼¸ä¸­)
            showMessage(successMessage, 'success');
            
            // å®šç¾©æˆåŠŸå¾Œæ¸…ç©ºè¡¨å–®çš„é‚è¼¯
            const resetFormAndState = () => {
                form.reset();
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('timestamp').value = now.toISOString().slice(0, 16);
                resetCurrencySelect();
                setPendingStatus(false);
                setTransactionType(currentTransactionType); // åˆ·æ–°è¡¨å–®ç‹€æ…‹
            };

            // *** æ ¸å¿ƒ API å„²å­˜é‚è¼¯ (ä½¿ç”¨ Fetch API) ***
            saveTransactionToSheet(transactionsToSave, resetFormAndState);
        });

        // ğŸ“¢ æ–°å¢ï¼šå¾ Apps Script è®€å–æ‰€æœ‰äº¤æ˜“è³‡æ–™
        /**
         * å¾ Apps Script è®€å–æ‰€æœ‰äº¤æ˜“è³‡æ–™
         * @returns {Array} äº¤æ˜“è³‡æ–™é™£åˆ—
         */
        async function fetchTransactions() {
            if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL_HERE') {
                console.error('è«‹è¨­ç½®æ­£ç¢ºçš„ APPS_SCRIPT_URL!');
                return [];
            }
            
            // å‘¼å« Apps Script çš„ doGet æœå‹™ï¼ŒåŠ ä¸Š action=read åƒæ•¸
            const readUrl = `${APPS_SCRIPT_URL}?action=read`;
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const summaryTitleElement = document.getElementById('summaryView').querySelector('h2');
            const originalTitle = summaryTitleElement.textContent;
            summaryTitleElement.textContent = 'è¼‰å…¥ä¸­... è«‹ç¨å€™ â³';

            try {
                const response = await fetch(readUrl, {
                    method: 'GET',
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.status === 'success') {
                    // æˆåŠŸè¼‰å…¥å¾Œï¼Œæ›´æ–°æ¨™é¡Œ
                    summaryTitleElement.textContent = originalTitle; 
                    // è¿”å›å¾ Google Sheet è®€å–çš„äº¤æ˜“è³‡æ–™
                    return data.data; 
                } else {
                    showMessage(`âŒ è¼‰å…¥éŒ¯èª¤: ${data.message}`, 'error');
                    summaryTitleElement.textContent = 'è¼‰å…¥å¤±æ•— âŒ';
                    return [];
                }
                
            } catch (error) {
                showMessage(`âŒ é€£ç·šæˆ–è®€å–å¤±æ•—: ${error.message}`, 'error');
                summaryTitleElement.textContent = 'è¼‰å…¥å¤±æ•— âŒ';
                return [];
            }
        }
        
        // ğŸ“¢ æ–°å¢ï¼šè¼‰å…¥å¾Œç«¯æ•¸æ“šä¸¦æ¸²æŸ“æ‘˜è¦é é¢
        /**
         * è¼‰å…¥å¾Œç«¯æ•¸æ“šä¸¦æ¸²æŸ“æ‘˜è¦é é¢
         */
        async function loadAndRenderSummary() {
            // ç¢ºä¿åªåœ¨ summary é é¢åŸ·è¡Œ
            if (currentTab !== 'summary') return;
            
            // å‘¼å«æ–°å¢çš„è®€å–å‡½å¼ï¼Œå°‡çµæœå­˜å…¥å…¨å±€çš„ allTransactionsData è®Šæ•¸
            const transactions = await fetchTransactions();
            allTransactionsData = transactions; 
            
            // æ¸²æŸ“æ‘˜è¦é é¢
            renderSummary(); 
        }

        // ============== 2. æ‘˜è¦åˆ†æé‚è¼¯ (å·²ä¿®æ”¹è³‡æ–™æº) ==============

        function setSummaryView(view) {
            summaryViewType = view;
            
            const monthBtn = document.getElementById('viewToggleMonth');
            const yearBtn = document.getElementById('viewToggleYear');
            
            const activeClass = 'bg-blue-500 text-white shadow-md'; 
            const inactiveClass = 'text-gray-600 bg-gray-50';

            monthBtn.classList.remove(...activeClass.split(' '), ...inactiveClass.split(' '));
            yearBtn.classList.remove(...activeClass.split(' '), ...inactiveClass.split(' '));

            if (view === 'month') {
                monthBtn.classList.add(...activeClass.split(' '));
                yearBtn.classList.add(...inactiveClass.split(' '));
            } else {
                yearBtn.classList.add(...activeClass.split(' '));
                monthBtn.classList.add(...inactiveClass.split(' '));
            }
            // ğŸ“¢ ä½¿ç”¨å·²è¼‰å…¥çš„å…¨å±€æ•¸æ“šé€²è¡Œæ¸²æŸ“
            renderSummary(); 
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        function renderSummary() {
            // ğŸ“¢ ä½¿ç”¨å…¨å±€è®Šæ•¸ allTransactionsData ä½œç‚ºæ•¸æ“šæº
            const transactions = allTransactionsData; 
            
            // å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œå¿«é€Ÿé€€å‡ºä¸¦æç¤º
            if (!transactions || transactions.length === 0) {
                document.getElementById('totalIncomeTWD').textContent = '0';
                document.getElementById('totalExpenseTWD').textContent = '0';
                document.getElementById('netFlowTWD').textContent = 'TWD 0';
                document.getElementById('categorySummaryList').innerHTML = '<li class="text-center py-4 text-gray-500 bg-gray-50 rounded-lg">æ­¤æœŸé–“ç„¡å¯¦æ‰£ TWD æ”¯å‡ºç´€éŒ„</li>';
                document.getElementById('accountSummaryList').innerHTML = '<li class="text-center py-4 text-gray-500 bg-gray-50 rounded-lg">æ­¤æœŸé–“ç„¡å¸³æˆ¶è³‡é‡‘æµå‹•ç´€éŒ„</li>';
                document.getElementById('transactionDetailList').innerHTML = '<li class="text-center py-4 text-gray-500 bg-gray-50 rounded-lg">æ­¤æœŸé–“ç„¡å¯¦æ‰£äº¤æ˜“æ˜ç´°ç´€éŒ„</li>';
                return;
            }

            // ç²å–ç•¶å‰æ—¥æœŸä½œç‚ºåŸºæº–é» (ç”¨æ–¼ç¯©é¸æœˆ/å¹´)
            const now = new Date(); 
            const currentYear = now.getFullYear().toString();

            // æ ¼å¼åŒ–ç•¶å‰æœˆä»½ç‚º YYYY-MM
            const currentMonthPeriod = currentYear + '-' + (now.getMonth() + 1).toString().padStart(2, '0');
            
            // æ±ºå®šç•¶å‰ç¯©é¸çš„æœŸé–“å€¼
            const currentPeriod = summaryViewType === 'month' ? currentMonthPeriod : currentYear;

            // 1. éæ¿¾ä¸¦è¨ˆç®—ç•¶å‰æœŸé–“çš„äº¤æ˜“ (åªè¨ˆç®—å·²çµç®—/éé æˆæ¬Š)
            const filteredData = transactions.filter(t => {
                // æ’é™¤é æˆæ¬Šçš„æ”¯å‡º
                if (t.type === 'expense' && t.isPending) return false; 
                
                // ğŸ“¢ æ³¨æ„ï¼šApps Script è¿”å›çš„ timestamp å¯èƒ½æ˜¯å­—ä¸²ï¼Œéœ€è¦è½‰æ›ç‚º Date ç‰©ä»¶
                const date = new Date(t.timestamp);
                
                let transactionPeriod;
                if (summaryViewType === 'month') {
                    // äº¤æ˜“çš„æœˆä»½æœŸé–“ YYYY-MM
                    transactionPeriod = date.getFullYear() + '-' + (date.getMonth() + 1).toString().padStart(2, '0');
                } else {
                    // äº¤æ˜“çš„å¹´ä»½æœŸé–“ YYYY
                    transactionPeriod = date.getFullYear().toString();
                }

                // åªåŒ…å«åœ¨ç•¶å‰é¸æ“‡æœŸé–“å…§çš„äº¤æ˜“
                return transactionPeriod === currentPeriod;
            });

            // 2. è¨ˆç®—ç¸½æ”¶å…¥ã€ç¸½æ”¯å‡ºå’Œæ·¨é¡ (åƒ… TWD)
            let totalIncomeTWD = 0;
            let totalExpenseTWD = 0;
            let twdNetFlow = 0;

            const categoryTotals = {}; // åƒ…ç”¨æ–¼ TWD æ”¯å‡º/è½‰å‡ºåˆ†æ
            const accountFlows = {}; // å¸³æˆ¶æ·¨é¡

            filteredData.forEach(t => {
                // æ›´æ–°å¸³æˆ¶æ·¨é¡
                // æ³¨æ„ï¼šé€™è£¡æ‡‰è©²è™•ç†å¤šå¹£åˆ¥æƒ…æ³ï¼Œä½†ç‚ºäº†ç°¡å–®ï¼Œå…ˆä¸æ›ç®—ï¼Œåªç´¯åŠ 
                accountFlows[t.account] = (accountFlows[t.account] || 0) + t.amount;
                
                // åƒ…è¨ˆç®— TWD é€²è¡Œç¸½è¨ˆ
                if (t.currency === 'TWD') {
                    // æ”¶å…¥å’Œè½‰å…¥ (æ­£å€¼)
                    if (t.type === 'income' || t.type === 'transfer_in') {
                        totalIncomeTWD += t.amount;
                        twdNetFlow += t.amount;
                    } 
                    // æ”¯å‡ºå’Œè½‰å‡º (è² å€¼)
                    else if (t.type === 'expense' || t.type === 'transfer_out') {
                        // ç”±æ–¼è½‰å‡ºå’Œæ”¯å‡ºéƒ½ä»¥è² æ•¸å­˜å„², amount æ˜¯è² å€¼
                        totalExpenseTWD += Math.abs(t.amount); // ç¸½æ”¯å‡ºæ˜¯æ­£æ•¸
                        twdNetFlow += t.amount; // æ·¨é¡è¨ˆç®—ç”¨è² å€¼
                        
                        // é¡åˆ¥åˆ†æï¼šåªåˆ†ææ”¯å‡ºçš„é¡åˆ¥
                        if (t.type === 'expense') {
                             categoryTotals[t.category] = (categoryTotals[t.category] || 0) + Math.abs(t.amount);
                        }
                    }
                }
            });

            // 3. æ¸²æŸ“ç¸½çµå¡ç‰‡
            document.getElementById('totalIncomeTWD').textContent = totalIncomeTWD.toLocaleString('zh-TW');
            document.getElementById('totalExpenseTWD').textContent = totalExpenseTWD.toLocaleString('zh-TW');
            
            const netFlowElement = document.getElementById('netFlowTWD');
            netFlowElement.textContent = formatCurrencyDisplay(twdNetFlow, 'TWD', twdNetFlow < 0);
            netFlowElement.classList.remove('text-green-600', 'text-red-600');
            netFlowElement.classList.add(twdNetFlow >= 0 ? 'text-green-600' : 'text-red-600');
            
            document.getElementById('summaryPeriodText').textContent = 
                summaryViewType === 'month' ? 
                `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ ç¸½çµ` : 
                `${now.getFullYear()}å¹´åº¦ ç¸½çµ`;


            // 4. æ¸²æŸ“é¡åˆ¥åˆ—è¡¨ (åƒ…é¡¯ç¤ºæ”¯å‡ºé¡åˆ¥)
            const catList = document.getElementById('categorySummaryList');
            catList.innerHTML = '';
            const sortedCategories = Object.entries(categoryTotals).sort(([, a], [, b]) => b - a);
            
            if (sortedCategories.length === 0 && totalExpenseTWD === 0) {
                 catList.innerHTML = '<li class="text-center py-4 text-gray-500 bg-gray-50 rounded-lg">æ­¤æœŸé–“ç„¡å¯¦æ‰£ TWD æ”¯å‡ºç´€éŒ„</li>';
            } else {
                sortedCategories.forEach(([category, amount]) => {
                    const percentage = totalExpenseTWD > 0 ? ((amount / totalExpenseTWD) * 100).toFixed(1) : 0;
                    const li = `
                        <li class="flex justify-between items-center text-gray-800 border-b border-gray-50 last:border-b-0 py-1">
                            <span class="font-medium text-blue-600">${category}</span>
                            <div class="text-right">
                                <span class="font-semibold text-sm">${formatCurrencyDisplay(amount, 'TWD')}</span>
                                <span class="text-xs text-gray-500 ml-2">${percentage}%</span>
                            </div>
                        </li>
                    `;
                    catList.insertAdjacentHTML('beforeend', li);
                });
            }

            // 5. æ¸²æŸ“å¸³æˆ¶åˆ—è¡¨ (é¡¯ç¤ºæ·¨é¡)
            const accList = document.getElementById('accountSummaryList');
            accList.innerHTML = '';
            const sortedAccounts = Object.entries(accountFlows).sort(([, a], [, b]) => b - a);
            
            if (sortedAccounts.length === 0) {
                accList.innerHTML = '<li class="text-center py-4 text-gray-500 bg-gray-50 rounded-lg">æ­¤æœŸé–“ç„¡å¸³æˆ¶è³‡é‡‘æµå‹•ç´€éŒ„</li>';
            } else {
                sortedAccounts.forEach(([account, amount]) => {
                    // ç‚ºäº† UI æ¼”ç¤ºï¼Œæˆ‘å€‘å¾ filteredData æ‰¾åˆ°è©²å¸³æˆ¶æœ€è¿‘ä¸€æ¬¡ä½¿ç”¨çš„è²¨å¹£
                    const currency = filteredData.find(t => t.account === account)?.currency || 'TWD';
                    const isPositive = amount >= 0;
                    const colorClass = isPositive ? 'text-green-700' : 'text-red-700';
                    const icon = isPositive ? 'trending-up' : 'trending-down';
                    
                    const li = `
                        <li class="p-3 bg-gray-50 rounded-lg flex justify-between items-center text-sm shadow-sm">
                            <div class="flex flex-col flex-1 truncate">
                                <div class="flex items-center space-x-2 font-semibold text-gray-800 truncate">
                                    <i data-lucide="${icon}" class="w-4 h-4 ${colorClass}"></i>
                                    <span class="truncate">${account}</span>
                                </div>
                            </div>
                            <div class="font-bold whitespace-nowrap ${colorClass} text-base">
                                ${formatCurrencyDisplay(amount, currency, amount < 0)}
                            </div>
                        </li>
                    `;
                    accList.insertAdjacentHTML('beforeend', li);
                });
            }

            // 6. æ¸²æŸ“äº¤æ˜“æ˜ç´°æ¸…å–® (Transaction Details)
            const detailList = document.getElementById('transactionDetailList');
            detailList.innerHTML = '';

            if (filteredData.length === 0) {
                detailList.innerHTML = '<li class="text-center py-4 text-gray-500 bg-gray-50 rounded-lg">æ­¤æœŸé–“ç„¡å¯¦æ‰£äº¤æ˜“æ˜ç´°ç´€éŒ„</li>';
            } else {
                // æŒ‰æ—¥æœŸé™åºæ’åˆ—
                const sortedDetails = filteredData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                sortedDetails.forEach(t => {
                    const isExpense = t.amount < 0;
                    const colorClass = isExpense ? 'text-red-600' : 'text-green-600';
                    const sign = isExpense ? '' : '+'; // + for income/transfer_in
                    const displayAmount = (sign + Math.abs(t.amount)).toLocaleString('zh-TW');
                    
                    // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“ç‚º MM/DD HH:MM
                    const date = new Date(t.timestamp);
                    const displayTime = date.toLocaleDateString('zh-TW', {
                        month: '2-digit',
                        day: '2-digit',
                    }) + ' ' + date.toLocaleTimeString('zh-TW', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                    
                    // æ±ºå®šé¡å‹å’Œåœ–æ¨™
                    let typeLabel = '';
                    let typeIcon = '';
                    switch (t.type) {
                        case 'expense':
                            typeLabel = 'æ”¯å‡º';
                            typeIcon = 'minus';
                            break;
                        case 'income':
                            typeLabel = 'æ”¶å…¥';
                            typeIcon = 'plus';
                            break;
                        case 'transfer_out':
                            typeLabel = 'è½‰å‡º';
                            typeIcon = 'arrow-up-right';
                            break;
                        case 'transfer_in':
                            typeLabel = 'è½‰å…¥';
                            typeIcon = 'arrow-down-left';
                            break;
                    }

                    const li = `
                        <li class="p-3 bg-gray-50 rounded-lg flex justify-between items-center text-sm shadow-sm">
                            <div class="flex flex-col flex-1 truncate">
                                <div class="flex items-center space-x-2 font-semibold text-gray-800 truncate">
                                    <i data-lucide="${typeIcon}" class="w-4 h-4 ${colorClass}"></i>
                                    <span class="truncate">${t.category} - ${t.description || typeLabel}</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-0.5 ml-6 truncate">
                                    ${t.account} (${displayTime})
                                </div>
                            </div>
                            <div class="font-bold whitespace-nowrap ${colorClass} text-base">
                                ${t.currency} ${displayAmount}
                            </div>
                        </li>
                    `;
                    detailList.insertAdjacentHTML('beforeend', li);
                });
            }

            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            // è¨­ç½® timestamp é è¨­å€¼ç‚ºç•¶å‰æ™‚é–“
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('timestamp').value = now.toISOString().slice(0, 16);
            
            // ç¢ºä¿æ‰€æœ‰ç‹€æ…‹åˆå§‹åŒ–
            switchTab('input'); 
            setTransactionType('expense'); // ç¢ºä¿é¡åˆ¥è¢«å¡«å……
            setPendingStatus(false); 
            setSummaryView('month');
            resetCurrencySelect(); 
        });
    </script>
</body>
</html>